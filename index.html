<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Danh Sách Yêu Cầu Dịch Vụ IT</title>

  <!-- Bootstrap 5 + DataTables -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.19.1/css/dataTables.bootstrap5.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    body {font-family:'Roboto',sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;padding:30px 0;}
    .card {background:#fff;border-radius:20px;box-shadow:0 15px 35px rgba(0,0,0,0.2);overflow:hidden;}
    h1 {background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:30px;margin:0;text-align:center;border-radius:20px 20px 0 0;}
    .badge-success {background:#d4edda;color:#155724;padding:8px 18px;border-radius:50px;font-weight:500;}
    .badge-warning {background:#fff3cd;color:#856404;padding:8px 18px;border-radius:50px;font-weight:500;}
    .table th {background:#0d6efd;color:#fff;text-align:center;}
    .update-time {font-size:0.95rem;color:#fff;text-align:center;margin:20px 0;}
    .spinner-border {width:3rem;height:3rem;}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>DANH SÁCH YÊU CẦU DỊCH VỤ / BẢO TRÌ IT</h1>
      <div class="card-body p-4">

        <div class="table-responsive">
          <table id="bang" class="table table-striped table-hover table-bordered">
            <thead>
              <tr>
                <th>STT</th>
                <th>Ngày</th>
                <th>Nội dung</th>
                <th>Họ tên</th>
                <th>Nơi yêu cầu</th>
                <th>Tình trạng</th>
                <th>Ghi chú</th>
              </tr>
            </thead>
            <tbody id="tableBody">
              <tr>
                <td colspan="7" class="text-center py-5">
                  <div class="spinner-border text-primary" role="status"></div>
                  <div class="mt-3 text-primary fw-bold">Đang tải dữ liệu từ Google Sheet...</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="update-time">
          Cập nhật lúc: <span id="lastUpdate">-</span>
        </div>

        <div class="text-center">
          <a href="https://docs.google.com/spreadsheets/d/1qyOUDSPjeDwM2D_djvob0SAJtbXAnu2KcxNCR4y9Twg/edit" 
             target="_blank" class="btn btn-light btn-lg shadow">
            Mở Google Sheet gốc
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- JS -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.19.1/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.19.1/js/dataTables.bootstrap5.min.js"></script>

  <script>
    // === BƯỚC DUY NHẤT BẠN CẦN LÀM: DÁN LINK API REALTIME VÀO ĐÂY ===
    const API_URL = "https://script.google.com/macros/s/AKfycbzPgoIfMoiPzBjFNrldLbQfOt2vfzcjr9kj33UFxfrBCLiN3LrHAEsDGRjVjozpNpG3KQ/exec"; 
    // ← Thay bằng link bạn tạo từ Apps Script (bước deploy "Anyone")

    $(document).ready(function() {
      function loadData() {
        $.getJSON(API_URL + "?t=" + new Date().getTime())
          .done(function(res) {
            const data = res.data || [];
            let html = '';
            data.forEach((row, i) => {
              const badge = row[4] === "Hoàn thành" 
                ? '<span class="badge badge-success">Hoàn thành</span>'
                : '<span class="badge badge-warning">Chưa xử lý</span>';
              html += `
                <tr>
                  <td class="text-center fw-bold">${i+1}</td>
                  <td class="text-center">${row[0] || '-'}</td>
                  <td><strong>${row[1] || '-'}</strong></td>
                  <td>${row[2] || '-'}</td>
                  <td>${row[3] || '-'}</td>
                  <td class="text-center">${badge}</td>
                  <td>${row[5] || '-'}</td>
                </tr>`;
            });
            $('#tableBody').html(html || '<tr><td colspan="7" class="text-center">Chưa có dữ liệu</td></tr>');
            initDataTable();
            $('#lastUpdate').text(new Date().toLocaleString('vi-VN'));
          })
          .fail(function() {
            $('#tableBody').html('<tr><td colspan="7" class="text-center text-danger py-4">Lỗi kết nối Google Sheet<br><small>Kiểm tra lại link API hoặc quyền "Anyone"</small></td></tr>');
          });
      }

      function initDataTable() {
        if ($.fn.DataTable.isDataTable('#bang')) {
          $('#bang').DataTable().destroy();
        }
        $('#bang').DataTable({
          language: { url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/vi.json' },
          pageLength: 10,
          lengthMenu: [10, 25, 50, 100],
          order: [[1, 'desc']], // sắp xếp theo ngày mới nhất
          columnDefs: [{ orderable: false, targets: [5,6] }]
        });
      }

      loadData();
    });
  </script>
</body>
</html>
