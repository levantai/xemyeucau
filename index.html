<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Danh Sách Yêu Cầu Dịch Vụ IT</title>

  <!-- Bootstrap 5 + DataTables -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.datatables.net/2.1.8/css/dataTables.bootstrap5.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    body {font-family:'Roboto',sans-serif;background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);min-height:100vh;padding:20px 0;}
    .container {background:#fff;border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,.15);overflow:hidden;}
    h1 {background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:30px;margin:0;text-align:center;}
    .badge-success {background:#d4edda !important;color:#155724 !important;padding:8px 16px;border-radius:50px;font-size:0.85em;}
    .badge-warning {background:#fff3cd !important;color:#856404 !important;padding:8px 16px;border-radius:50px;font-size:0.85em;}
    .table th {background:#0d6efd;color:#fff;text-align:center;}
    .update-time {font-size:0.9rem;color:#6c757d;text-align:center;}
    .loading {text-align:center;padding:60px;color:#6c757d;}
  </style>
</head>
<body>
  <div class="container">
    <h1>DANH SÁCH YÊU CẦU DỊCH VỤ / BẢO TRÌ IT</h1>
    <div class="p-4">
      <div class="table-responsive">
        <table id="dataTable" class="table table-striped table-hover table-bordered">
          <thead>
            <tr>
              <th>STT</th>
              <th>Ngày</th>
              <th>Nội dung</th>
              <th>Họ tên</th>
              <th>Nơi yêu cầu</th>
              <th>Tình trạng</th>
              <th>Ghi chú</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr><td colspan="7" class="loading">
              <div class="spinner-border text-primary" role="status"></div><br>
              Đang tải dữ liệu từ Google Sheet...
            </td></tr>
          </tbody>
        </table>
      </div>
      <div class="text-center mt-4">
        <p class="update-time">Cập nhật lúc: <span id="lastUpdate">-</span></p>
        <a href="https://docs.google.com/spreadsheets/d/1qyOUDSPjeDwM2D_djvob0SAJtbXAnu2KcxNCR4y9Twg/edit" 
           target="_blank" class="btn btn-outline-primary btn-lg">Mở Google Sheet gốc</a>
      </div>
    </div>
  </div>

  <!-- JS -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/2.1.8/js/dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/2.1.8/js/dataTables.bootstrap5.min.js"></script>

  <script>
    // === BƯỚC QUAN TRỌNG: DÁN LINK API JSON THẬT VÀO ĐÂY (sau khi deploy hàm getDataApi được deploy với "Anyone") ===
    const API_URL = "";   // ← Để trống hoặc dán link thật, ví dụ: "https://script.google.com/macros/s/AKfycb.../exec"

    // DỮ LIỆU MẪU (tự động chạy nếu API lỗi hoặc chưa có)
    const sampleData = {
      data: [
        ["29/11/2025","Máy in hư","Lê Văn Tài","TYTP Minh Phụng","Hoàn thành","-"],
        ["28/11/2025","Máy tính chậm","Nam","TYTP Phú Thọ","Chưa xử lý","Cần kiểm tra RAM"],
        ["27/11/2025","Lỗi phần mềm","Thái","TYTP Minh Phụng - Điểm y tế 2","Chưa xử lý",""],
        ["26/11/2025","Màn chiếu hỏng","Hiển","TYTP Hòa Bình","Hoàn thành","Đã thay mới"],
        ["25/11/2025","Chuột bàn phím lỗi","Iiiiiiii","TYTP Bình Thới","Chưa xử lý","-"],
        ["24/11/2025","Office win lỗi","0pppppp","TYTP Phú Thọ","Chưa xử lý",""],
        ["23/11/2025","Treo máy tính","Lê văn Tài","TYTP Bình Thới - Điểm y tế 2","Chưa xử lý","-"]
      ]
    };

    $(document).ready(function() {
      let finalData = sampleData.data;
      let usingSample = true;

      if (API_URL) {
        $.getJSON(API_URL + "?t=" + new Date().getTime())  // tránh cache
          .done(function(res) {
            if (res && res.data && res.data.length > 0) {
              finalData = res.data;
              usingSample = false;
            }
          })
          .fail(function() {
            console.log("API lỗi → dùng dữ liệu mẫu");
          })
          .always(function() {
            renderTable(finalData, usingSample);
          });
      } else {
        renderTable(finalData, usingSample);
      }

      function renderTable(data, isSample) {
        let html = '';
        data.forEach((row, i) => {
          const badge = row[4] === "Hoàn thành"
            ? '<span class="badge badge-success">Hoàn thành</span>'
            : '<span class="badge badge-warning">Chưa xử lý</span>';
          html += `
            <tr>
              <td class="text-center fw-bold">${i+1}</td>
              <td class="text-center">${row[0]}</td>
              <td><strong>${row[1]}</strong></td>
              <td>${row[2]}</td>
              <td>${row[3]}</td>
              <td class="text-center">${badge}</td>
              <td>${row[5] || '-'}</td>
            </tr>`;
        });
        $('#tableBody').html(html);

        $('#dataTable').DataTable({
          language: { url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/vi.json' },
          pageLength: 10,
          lengthMenu: [10, 25, 50, 100],
          order: [[0, 'desc']],
          destroy: true
        });

        const note = isSample ? " (Dữ liệu mẫu – Đang chờ API thật)" : "";
        $('#lastUpdate').text(new Date().toLocaleString('vi-VN') + note);
      );
      }
    });
  </script>
</body>
</html>
